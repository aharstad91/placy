!function(){"use strict";const e={CHAPTER_THRESHOLD:.5,DEBOUNCE_DELAY:100,MARKER_FADE_DURATION:200,FIT_BOUNDS_PADDING:80,DEFAULT_ZOOM:13,DEFAULT_CENTER:[10.3951,63.4305],MARKER_SIZES:{SMALL:{size:24,minZoom:12,maxZoom:14},MEDIUM:{size:48,minZoom:15,maxZoom:22}},LABEL_COLLISION_ZOOM_START:15,LABEL_COLLISION_ZOOM_END:18,LABEL_MIN_DISTANCE:140,LABEL_PRIORITY_DISTANCE:100,LABEL_MAX_VISIBLE:8};let t=null,o=[];new Map;let a=null;const n=new Map;let r=[];const s=new Map;function i(e,t){if(!e)return null;const o="undefined"!=typeof placyMapConfig&&placyMapConfig.googlePlacesApiKey?placyMapConfig.googlePlacesApiKey:"";if(!o)return console.warn("Google Places API key not configured"),null;if(e.startsWith("places/"))return`https://places.googleapis.com/v1/${e}/media?maxWidthPx=${t}&key=${o}`;return"https://maps.googleapis.com/maps/api/place/photo?"+new URLSearchParams({maxwidth:t.toString(),photo_reference:e,key:o}).toString()}let l=[];const c=new Map;function d(t){return t>=e.MARKER_SIZES.MEDIUM.minZoom?e.MARKER_SIZES.MEDIUM.size:e.MARKER_SIZES.SMALL.size}function p(t){const o=d(t);console.log("Current zoom level:",t,"| Marker size:",o+"px");document.querySelectorAll(".marker-circle-container, .marker-image-container").forEach(function(e){const t=e.closest(".tema-story-marker-wrapper"),a=(t&&t.classList.contains("marker-active"),e.style.transform);e.style.width=o+"px",e.style.height=o+"px",a&&a.includes("scale")||(e.style.transform="scale(1)")}),function(t){const o=document.querySelectorAll(".marker-info-card, .marker-label-poi"),a=Math.max(0,Math.min(1,(t-e.LABEL_COLLISION_ZOOM_START)/(e.LABEL_COLLISION_ZOOM_END-e.LABEL_COLLISION_ZOOM_START))),n=e.LABEL_MIN_DISTANCE+40*(1-a),r=t<16?Math.floor(e.LABEL_MAX_VISIBLE*(.75+.25*a)):1/0,s=[];o.forEach(function(o){const a=o.closest(".tema-story-marker-wrapper");if(!a)return;const n=o.hasAttribute("data-force-visible"),r=a.classList.contains("marker-active"),i="property"===a.getAttribute("data-marker-type"),l=a.getBoundingClientRect();s.push({label:o,wrapper:a,isHovered:n,isActive:r,isProperty:i,x:l.left+l.width/2,y:l.top+l.height/2,shouldShow:n||r||t>=e.LABEL_COLLISION_ZOOM_START})}),s.sort(function(e,t){return e.isActive&&!t.isActive?-1:!e.isActive&&t.isActive?1:e.isHovered&&!t.isHovered?-1:!e.isHovered&&t.isHovered?1:0});const i=[];let l=0;s.forEach(function(o){const{label:s,wrapper:c,isHovered:d,isActive:p,shouldShow:u,x:y,y:m}=o;if(d||p)s.style.opacity="1",s.style.visibility="visible",s.style.pointerEvents="auto",s.style.transform="none",i.push({x:y,y:m}),l++;else if(t<e.LABEL_COLLISION_ZOOM_START)s.style.opacity="0",s.style.visibility="hidden",s.style.pointerEvents="none";else if(t<16){if(i.some(function(e){return Math.sqrt(Math.pow(e.x-y,2)+Math.pow(e.y-m,2))<n})||l>=r)s.style.opacity="0",s.style.visibility="hidden",s.style.pointerEvents="none";else{const e=.85+.15*a;s.style.opacity=e.toString(),s.style.visibility="visible",s.style.pointerEvents="auto",s.style.transform="none",i.push({x:y,y:m}),l++}}else if(t<e.LABEL_COLLISION_ZOOM_END){i.some(function(t){return Math.sqrt(Math.pow(t.x-y,2)+Math.pow(t.y-m,2))<e.LABEL_PRIORITY_DISTANCE})?(s.style.transform="translateY(-8px)",s.style.opacity="0.9"):(s.style.transform="none",s.style.opacity="1"),s.style.visibility="visible",s.style.pointerEvents="auto",i.push({x:y,y:m})}else{const e=i.some(function(e){return Math.sqrt(Math.pow(e.x-y,2)+Math.pow(e.y-m,2))<60});s.style.transform=e?"translateY(-10px)":"none",s.style.opacity="1",s.style.visibility="visible",s.style.pointerEvents="auto",i.push({x:y,y:m})}});document.querySelectorAll(".marker-label-property").forEach(function(e){e.style.opacity="1",e.style.visibility="visible",e.style.pointerEvents="auto",e.style.transform="none"})}(t)}function u(e,t,n){const r=document.createElement("div");r.className="tema-story-marker-wrapper",r.style.display="flex",r.style.flexDirection="row",r.style.alignItems="center",r.style.gap="10px",r.style.cursor="pointer",r.style.zIndex="10",r.style.filter="drop-shadow(0 2px 4px rgba(0,0,0,0.3))",r.style.transition="filter 0.2s ease";const s=d(e.getZoom()),i=document.createElement("div");i.className="marker-image-container",i.style.width=s+"px",i.style.height=s+"px",i.style.borderRadius="50%",i.style.overflow="hidden",i.style.border="2px solid white",i.style.flexShrink="0",i.style.transition="transform 0.2s ease, width 0.3s ease, height 0.3s ease",i.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)",t.image?(i.style.backgroundImage=`url(${t.image})`,i.style.backgroundSize="cover",i.style.backgroundPosition="center"):i.style.backgroundColor="#9CA3AF";const l=document.createElement("div");l.className="marker-info-card",l.style.display="flex",l.style.flexDirection="column",l.style.minWidth="0",l.style.maxWidth="140px",l.style.transition="opacity 0.4s ease, visibility 0.4s ease, transform 0.3s ease";e.getZoom()<15?(l.style.opacity="0",l.style.visibility="hidden",l.style.pointerEvents="none"):(l.style.opacity="1",l.style.visibility="visible",l.style.pointerEvents="auto");const c=document.createElement("div");c.className="marker-name-label",c.textContent=t.title,c.style.fontSize="13px",c.style.fontWeight="600",c.style.color="#1a202c",c.style.lineHeight="1.3",c.style.whiteSpace="nowrap",c.style.overflow="hidden",c.style.textOverflow="ellipsis",c.style.marginBottom="2px",c.style.textShadow="rgba(255, 255, 255, 0.9) 1px 1px 1px, rgba(255, 255, 255, 0.8) 0px 0px 8px",l.appendChild(c);const p=document.createElement("div");if(p.style.display="flex",p.style.alignItems="center",p.style.gap="10px",p.style.fontSize="11px",p.style.color="#6B7280",t.rating){const e=document.createElement("span");e.style.display="flex",e.style.alignItems="center",e.style.gap="2px";const o=document.createElement("span");o.textContent="‚òÖ",o.style.color="#FBBC05",o.style.fontSize="12px",e.appendChild(o);const a=document.createElement("span");a.textContent=t.rating.value.toFixed(1),a.style.fontWeight="500",a.style.color="#374151",a.style.textShadow="0 1px 3px rgba(255,255,255,0.9), 0 0 8px rgba(255,255,255,0.8)",e.appendChild(a),p.appendChild(e)}if(t.walking){const e=document.createElement("span");e.textContent=g(t.walking.duration),e.style.fontWeight="500",e.style.textShadow="0 1px 3px rgba(255,255,255,0.9), 0 0 8px rgba(255,255,255,0.8)",p.appendChild(e)}l.appendChild(p),r.appendChild(i),r.appendChild(l),r.setAttribute("data-poi-id",t.id),r.setAttribute("data-chapter-id",n),r.setAttribute("data-marker-type","poi"),r.addEventListener("mouseenter",function(){r.classList.contains("marker-active")||(i.style.transform="scale(1.1)",r.style.zIndex="50",r.style.filter="drop-shadow(0 4px 8px rgba(0,0,0,0.4))",l.style.opacity="1",l.style.visibility="visible",l.style.pointerEvents="auto",l.setAttribute("data-force-visible","true"))}),r.addEventListener("mouseleave",function(){if(!r.classList.contains("marker-active")){i.style.transform="scale(1)",r.style.zIndex="10",r.style.filter="drop-shadow(0 2px 4px rgba(0,0,0,0.3))",l.removeAttribute("data-force-visible");e.getZoom()<15&&(l.style.opacity="0",l.style.visibility="hidden",l.style.pointerEvents="none")}}),r.addEventListener("click",function(o){if(o.stopPropagation(),document.querySelectorAll('.tema-story-marker-wrapper[data-marker-type="poi"]').forEach(function(t){t.classList.remove("marker-active"),t.style.zIndex="10",t.style.filter="drop-shadow(0 2px 4px rgba(0,0,0,0.3))";const o=t.querySelector(".marker-image-container");o&&(o.style.transform="scale(1)");const a=t.querySelector(".marker-image-container");a&&(a.style.transform="scale(1)"),t.querySelector(".marker-info-card")&&(t.style.filter="drop-shadow(0 2px 4px rgba(0,0,0,0.3))");const n=t.querySelector(".marker-info-card");if(n&&!n.hasAttribute("data-force-visible")){e.getZoom()<15&&(n.style.opacity="0",n.style.visibility="hidden",n.style.pointerEvents="none")}}),r.classList.add("marker-active"),r.style.zIndex="100",r.style.filter="drop-shadow(0 6px 16px rgba(0,0,0,0.5))",i.style.transform="scale(1.15)",l.style.opacity="1",l.style.visibility="visible",l.style.pointerEvents="auto",l.setAttribute("data-force-visible","true"),a){const o=new mapboxgl.LngLatBounds;o.extend(a),o.extend(t.coords),e.fitBounds(o,{padding:120,duration:1200,maxZoom:16})}else e.flyTo({center:t.coords,zoom:16,duration:1200});t.walking&&t.walking.geometry&&setTimeout(function(){y(e,t.walking.geometry,t.walking.duration)},400),setTimeout(function(){L(t.id)},800)});const u=new mapboxgl.Marker({element:r,anchor:"left",offset:[0,-25]}).setLngLat(t.coords).addTo(e);o.push(u)}function y(e,t,o){f(e);const a="walking-route";if(t&&(e.addSource(a,{type:"geojson",data:{type:"Feature",properties:{},geometry:t}}),e.addLayer({id:a,type:"line",source:a,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#76908D","line-width":3,"line-opacity":.9,"line-dasharray":[.001,2]}}),o&&t.coordinates&&t.coordinates.length>0)){const a=t.coordinates;let n=0;const s=[0];for(let e=1;e<a.length;e++){const t=a[e][0]-a[e-1][0],o=a[e][1]-a[e-1][1];n+=Math.sqrt(t*t+o*o),s.push(n)}const i=n/2;let l=a[Math.floor(a.length/2)];for(let e=1;e<s.length;e++)if(s[e]>=i){const t=s[e-1],o=(i-t)/(s[e]-t);l=[a[e-1][0]+(a[e][0]-a[e-1][0])*o,a[e-1][1]+(a[e][1]-a[e-1][1])*o];break}const c=document.createElement("div");c.className="duration-label-card",c.style.backgroundColor="#ffffff",c.style.color="#1a1a1a",c.style.padding="6px 10px",c.style.borderRadius="8px",c.style.fontSize="13px",c.style.fontWeight="600",c.style.boxShadow="0 2px 8px rgba(0,0,0,0.15)",c.style.whiteSpace="nowrap",c.style.pointerEvents="none",c.textContent=g(o);const d=new mapboxgl.Marker({element:c,anchor:"center"}).setLngLat(l).addTo(e);r.push(d)}}async function m(e){if(!a)return null;const t=`${e[0]},${e[1]}`;if(n.has(t))return n.get(t);try{const o=`https://api.mapbox.com/directions/v5/mapbox/walking/${a[0]},${a[1]};${e[0]},${e[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`,r=await fetch(o),s=await r.json();if(s.routes&&s.routes.length>0){const e=s.routes[0],o={distance:e.distance,duration:e.duration,geometry:e.geometry};return n.set(t,o),o}}catch(e){console.error("Tema Story Map: Error fetching walking distance:",e)}return null}function g(e){const t=Math.round(e/60);if(t<60)return`${t} min`;const o=Math.floor(t/60),a=t%60;return 0===a?`${o} t`:`${o} t ${a} min`}function f(e){if(!e)return;r.forEach(e=>e.remove()),r=[];const t=e.getStyle();t&&t.layers&&(t.layers.forEach(function(t){t.id&&(t.id.startsWith("route-")||"walking-route"===t.id||"walking-route-label"===t.id)&&e.getLayer(t.id)&&e.removeLayer(t.id)}),t.sources&&Object.keys(t.sources).forEach(function(t){(t.startsWith("route-")||"walking-route"===t||"walking-route-label"===t)&&e.getSource(t)&&e.removeSource(t)}))}function h(){document.querySelectorAll(".chapter-map").forEach(function(e){const t=e._mapboxInstance;t&&f(t)})}async function b(e,t,o,a="restaurant",n=1500,r=4.3,i=20,l="",c=["lodging"],d=[]){if(s.has(e))return s.get(e);try{const p=document.querySelector('link[rel="https://api.w.org/"]')?.href||"/wp-json/",u=new URL(p+"placy/v1/google-points/query",window.location.origin);u.searchParams.append("lat",t),u.searchParams.append("lng",o),u.searchParams.append("category",a),u.searchParams.append("radius",n),u.searchParams.append("minRating",r),u.searchParams.append("minReviews",i),l&&l.trim()&&u.searchParams.append("keyword",l.trim()),c&&c.length>0&&u.searchParams.append("excludeTypes",JSON.stringify(c)),d&&d.length>0&&u.searchParams.append("excludePlaceIds",JSON.stringify(d)),console.log("[fetchNearbyPlaces] Querying Google Points CPT:",u.toString());const y=await fetch(u.toString());if(!y.ok)throw new Error("API request failed: "+y.status);const m=await y.json();return console.log("[fetchNearbyPlaces] CPT Query result:",{success:m.success,count:m.count,source:m.source}),s.set(e,m),m}catch(e){return console.error("Error fetching nearby places from CPT:",e),{success:!1,count:0,places:[]}}}function x(e,t,o){o.forEach(function(o){const a=document.createElement("div");a.className="tema-story-marker-wrapper places-api-marker",a.style.display="flex",a.style.flexDirection="row",a.style.alignItems="center",a.style.gap="10px",a.style.cursor="pointer",a.style.zIndex="5",a.style.filter="drop-shadow(0 2px 4px rgba(0,0,0,0.3))",a.style.transition="filter 0.2s ease",a.setAttribute("data-marker-type","places-api"),a.setAttribute("data-chapter-id",t),a.setAttribute("data-place-id",o.placeId);const n=Math.max(30,.85*d(e.getZoom())),r=document.createElement("div");if(r.className="marker-image-container",r.style.width=n+"px",r.style.height=n+"px",r.style.borderRadius="50%",r.style.overflow="hidden",r.style.border="2px solid white",r.style.flexShrink="0",r.style.transition="transform 0.2s ease, width 0.3s ease, height 0.3s ease",r.style.backgroundColor="#EF4444",r.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)",o.photoReference){const e=i(o.photoReference,100);e?(r.style.backgroundImage="url("+e+")",r.style.backgroundSize="cover",r.style.backgroundPosition="center"):r.innerHTML='<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;color:white;font-size:16px;">üìç</div>'}else r.innerHTML='<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;color:white;font-size:16px;">üìç</div>';const s=document.createElement("div");s.className="marker-info-card",s.style.display="flex",s.style.flexDirection="column",s.style.minWidth="0",s.style.maxWidth="140px",s.style.transition="opacity 0.4s ease, visibility 0.4s ease, transform 0.3s ease";e.getZoom()<15&&(s.style.opacity="0",s.style.visibility="hidden",s.style.pointerEvents="none");const c=document.createElement("div");c.className="marker-name-label",c.textContent=o.name,c.style.fontSize="12px",c.style.fontWeight="600",c.style.color="#1a202c",c.style.lineHeight="1.3",c.style.whiteSpace="nowrap",c.style.overflow="hidden",c.style.textOverflow="ellipsis",c.style.marginBottom="2px",c.style.textShadow="rgba(255, 255, 255, 0.9) 1px 1px 1px, rgba(255, 255, 255, 0.8) 0px 0px 8px",s.appendChild(c);const p=document.createElement("div");if(p.style.display="flex",p.style.alignItems="center",p.style.gap="10px",p.style.fontSize="10px",p.style.color="#6B7280",o.rating){const e=document.createElement("span");e.style.display="flex",e.style.alignItems="center",e.style.gap="2px";const t=document.createElement("span");t.textContent="‚òÖ",t.style.color="#FBBC05",t.style.fontSize="11px",e.appendChild(t);const a=document.createElement("span");a.textContent=o.rating.toFixed(1),a.style.fontWeight="500",a.style.color="#374151",a.style.textShadow="0 1px 3px rgba(255,255,255,0.9), 0 0 8px rgba(255,255,255,0.8)",e.appendChild(a),p.appendChild(e)}const u=document.createElement("span");u.textContent="Google",u.style.fontWeight="500",u.style.color="#9CA3AF",u.style.textShadow="0 1px 3px rgba(255,255,255,0.9), 0 0 8px rgba(255,255,255,0.8)",p.appendChild(u),s.appendChild(p),a.appendChild(r),a.appendChild(s),a.addEventListener("mouseenter",function(){r.style.transform="scale(1.1)",a.style.zIndex="45",a.style.filter="drop-shadow(0 4px 8px rgba(0,0,0,0.4))",s.style.opacity="1",s.style.visibility="visible",s.style.pointerEvents="auto",s.setAttribute("data-force-visible","true")}),a.addEventListener("mouseleave",function(){r.style.transform="scale(1)",a.style.zIndex="5",a.style.filter="drop-shadow(0 2px 4px rgba(0,0,0,0.3))",s.removeAttribute("data-force-visible");e.getZoom()<15&&(s.style.opacity="0",s.style.visibility="hidden",s.style.pointerEvents="none")}),a.addEventListener("click",function(e){e.stopPropagation();const t=document.querySelector('[data-place-id="'+o.placeId+'"]');t&&(t.scrollIntoView({behavior:"smooth",block:"nearest"}),t.style.boxShadow="0 0 0 3px #10B981",setTimeout(function(){t.style.boxShadow=""},2e3))});const y=[o.coordinates.lng,o.coordinates.lat],m=new mapboxgl.Marker({element:a,anchor:"left",offset:[0,-22]}).setLngLat(y).addTo(e);l.push(m)})}function v(e,t){const o=document.querySelector('.chapter[data-chapter-id="'+e+'"]');if(!o)return;const n=o.querySelectorAll(".poi-list-block");if(0===n.length)return;const r=n[n.length-1];if(r.querySelector(".places-api-show-all-button"))return;const s=document.createElement("div");s.className="places-api-button-container",s.style.marginTop="24px",s.style.textAlign="center";const i=document.createElement("button");i.className="places-api-show-all-button",i.textContent="Se flere "+t+" i omr√•det",i.setAttribute("data-category-norwegian",t),i.style.padding="12px 24px",i.style.backgroundColor="#EF4444",i.style.color="white",i.style.border="none",i.style.borderRadius="8px",i.style.fontSize="14px",i.style.fontWeight="600",i.style.cursor="pointer",i.style.transition="background-color 0.2s",i.addEventListener("mouseenter",function(){i.style.backgroundColor="#DC2626"}),i.addEventListener("mouseleave",function(){i.style.backgroundColor="#EF4444"}),i.addEventListener("click",function(){!async function(e,t){const o=c.get(e);if(o)return;const n=t.getAttribute("data-category-norwegian")||"steder",r=document.createElement("span");if(r.style.display="inline-block",r.style.width="14px",r.style.height="14px",r.style.border="2px solid rgba(255, 255, 255, 0.3)",r.style.borderTopColor="#fff",r.style.borderRadius="50%",r.style.marginRight="8px",r.style.animation="spin 0.8s linear infinite",!document.getElementById("spinner-keyframes")){const e=document.createElement("style");e.id="spinner-keyframes",e.textContent="\n                @keyframes spin {\n                    to { transform: rotate(360deg); }\n                }\n            ",document.head.appendChild(e)}t.innerHTML="",t.appendChild(r),t.appendChild(document.createTextNode("Henter lignende "+n+" fra Google...")),t.disabled=!0,t.style.opacity="0.9";const s=await async function(e){const t=document.querySelector('[data-chapter-id="'+e+'"]');if(!t)return null;const o=document.querySelector('.chapter-map[data-chapter-id="'+e+'"]');if(!o)return null;const n=o._mapboxInstance;if(!n)return null;let r,s;if(a)s=a[0],r=a[1];else{const e=n.getCenter();r=e.lat,s=e.lng}const i=t.getAttribute("data-places-category")||"restaurant",l=parseInt(t.getAttribute("data-places-radius"))||1500,c=parseFloat(t.getAttribute("data-places-min-rating"))||4.3,d=parseInt(t.getAttribute("data-places-min-reviews"))||50,p=t.getAttribute("data-places-keyword")||"";let u=["lodging"];const y=t.getAttribute("data-places-exclude-types");if(y)try{u=JSON.parse(y)}catch(e){console.warn("Failed to parse exclude types:",e)}const m=[],g=t.closest(".wp-block-placy-chapter-wrapper");if(g){g.querySelectorAll("[data-google-place-id]").forEach(function(e){const t=e.getAttribute("data-google-place-id");t&&t.trim()&&m.push(t.trim())}),console.log("[fetchApiData] Excluding "+m.length+" manually curated POIs from API search")}const f=await b(e,r,s,i,l,c,d,p,u,m);if(!f.success||0===f.places.length)return console.warn("No places found for chapter:",e),null;return f}(e);if(await new Promise(e=>setTimeout(e,2e3)),s&&s.success&&s.places.length>0){!function(e,t){const o=document.querySelector('.chapter-map[data-chapter-id="'+e+'"]');if(!o)return;const a=o._mapboxInstance;if(!a)return;x(a,e,t.places),function(e,t){const o=document.querySelector('.chapter[data-chapter-id="'+e+'"]');if(!o)return;const a=o.querySelectorAll(".poi-list-block");if(0===a.length)return;const n=a[a.length-1],r=n.querySelector(".flex.flex-col");if(!r)return;const s=o.getAttribute("data-places-category")||"restaurant",i=o.getAttribute("data-places-keyword")||"",l={restaurant:"restauranter",cafe:"kafeer",bar:"barer",bakery:"bakerier",meal_takeaway:"takeaway-steder",food:"spisesteder"}[s]||"steder",c=document.createElement("div");c.className="places-api-results",c.style.marginTop="24px",c.style.paddingTop="0";const d=document.createElement("div");d.className="google-places-disclaimer",d.style.marginBottom="16px",d.style.padding="12px 16px",d.style.backgroundColor="#F3F4F6",d.style.borderLeft="4px solid #9CA3AF",d.style.borderRadius="4px";let p='<p style="margin: 0; font-size: 14px; color: #4B5563; line-height: 1.5;">';p+='<strong style="color: #1F2937;">Google-s√∏k:</strong> ',i&&i.trim()?p+="Viser lignende <strong>"+l+'</strong> tagget med <em>"'+i.trim()+'"</em>':p+="Viser lignende <strong>"+l+"</strong> i omr√•det";p+=' <span style="color: #6B7280;">‚Äî hentet fra Google Places</span>',p+="</p>",d.innerHTML=p,c.appendChild(d),t.forEach(function(e){const t=w(e);c.appendChild(t)}),r.appendChild(c),setTimeout(function(){S()},500)}(e,t.places),k(a,t.places)}(e,s);const t=document.querySelector('[data-chapter-id="'+e+'"]');if(t){const o=new CustomEvent("placesLoaded",{detail:{chapterId:e,placesCount:s.places.length},bubbles:!0});t.dispatchEvent(o),console.log("[Google Places] Dispatched placesLoaded event for chapter:",e,"places:",s.places.length)}}c.set(e,!0),t.style.display="none"}(e,i)}),s.appendChild(i),r.appendChild(s)}function w(e){const t=document.createElement("article");t.className="poi-list-card bg-white border border-gray-200 rounded-lg overflow-hidden transition-all duration-300 hover:border-gray-300",t.style.backgroundColor="#F9FAFB",t.setAttribute("data-place-id",e.placeId),t.setAttribute("data-poi-id","gplace-"+e.placeId),t.setAttribute("data-google-place-id",e.placeId),t.setAttribute("data-marker-type","places-api"),t.setAttribute("data-poi-coords","["+e.coordinates.lat+","+e.coordinates.lng+"]");let o='<div class="poi-card-content flex gap-4 p-4">';if(e.photoReference){o+='<div class="flex-shrink-0">';o+='<img src="'+i(e.photoReference,200)+'" alt="'+e.name+'" class="w-24 h-24 rounded-lg object-cover">',o+="</div>"}return o+='<div class="flex-1 min-w-0 flex flex-col">',o+='<div class="flex items-start justify-between">',o+='<div class="flex flex-col mb-2">',o+='<h3 class="text-lg font-semibold text-gray-900">'+e.name+"</h3>",o+='<div class="flex items-center gap-2 mt-1 mb-2">',o+='<span class="inline-block px-2 py-1 text-xs font-medium text-gray-600 bg-gray-100 rounded">Fra Google</span>',o+="</div>",o+='<div class="flex items-center gap-4">',e.rating&&(o+='<div class="poi-rating flex items-center gap-2">',e.url?(o+='<a href="'+e.url+'" target="_blank" rel="noopener noreferrer" ',o+='class="flex items-center gap-2 hover:opacity-80 transition-opacity" ',o+='title="Se anmeldelser p√• Google" aria-label="Se anmeldelser p√• Google">',o+='<span class="flex items-center gap-1 text-sm font-medium text-gray-900">',o+='<span class="text-yellow-500">‚òÖ</span>',o+=e.rating.toFixed(1),o+="</span>",e.userRatingsTotal&&(o+='<span class="text-xs text-gray-500">('+e.userRatingsTotal+")</span>"),o+='<span class="flex items-center gap-1 text-xs text-gray-400">',o+='<svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">',o+='<path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>',o+='<path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>',o+='<path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>',o+='<path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>',o+="</svg>",o+='<span class="text-[10px]">Google</span>',o+="</span>",o+="</a>"):(o+='<span class="flex items-center gap-1 text-sm font-medium text-gray-900">',o+='<span class="text-yellow-500">‚òÖ</span>',o+=e.rating.toFixed(1),o+="</span>",e.userRatingsTotal&&(o+='<span class="text-xs text-gray-500">('+e.userRatingsTotal+")</span>")),o+="</div>"),o+='<div class="poi-travel-time flex items-center gap-2 text-gray-600" style="display: none;">',o+='<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">',o+='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>',o+="</svg>",o+='<span class="poi-travel-time-text text-sm font-medium"></span>',o+="</div>",o+="</div>",o+="</div>",o+='<div class="poi-button-container flex-shrink-0">',o+='<button onclick="showPlaceOnMap(this)" ',o+='class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium text-sm rounded-lg transition-colors duration-200 whitespace-nowrap" ',o+='data-place-coords="['+e.coordinates.lng+","+e.coordinates.lat+']">',o+="Se p√• kart",o+="</button>",o+="</div>",o+="</div>",e.vicinity&&(o+='<div class="text-sm text-gray-600 line-clamp-2">'+e.vicinity+"</div>"),o+="</div>",o+="</div>",t.innerHTML=o,t}function k(e,t){if(0===t.length)return;const n=new mapboxgl.LngLatBounds;a&&n.extend(a),o.forEach(function(e){const t=e.getLngLat();n.extend([t.lng,t.lat])});const r=Math.min(5,t.length);for(let e=0;e<r;e++)n.extend([t[e].coordinates.lng,t[e].coordinates.lat]);e.fitBounds(n,{padding:100,duration:1e3,maxZoom:14})}function A(){document.querySelectorAll(".chapter[data-chapter-id]").forEach(async function(e){const t=e.getAttribute("data-chapter-id");if(0===e.querySelectorAll(".poi-list-block").length)return;let o,n;if(a)n=a[0],o=a[1];else{const t=e.querySelector("[data-poi-coords]");if(!t)return;try{const e=JSON.parse(t.getAttribute("data-poi-coords"));o=e[0],n=e[1]}catch(e){return}}if(!("false"!==e.getAttribute("data-places-enabled")))return;const r=e.getAttribute("data-places-category")||"restaurant";e.getAttribute("data-places-keyword"),parseInt(e.getAttribute("data-places-radius")),parseFloat(e.getAttribute("data-places-min-rating")),parseInt(e.getAttribute("data-places-min-reviews"));let s=["lodging"];const i=e.getAttribute("data-places-exclude-types");if(i)try{s=JSON.parse(i)}catch(e){console.warn("Failed to parse exclude types:",e)}v(t,{restaurant:"restauranter",cafe:"kafeer",bar:"barer",bakery:"bakerier",meal_takeaway:"takeaway-steder",food:"spisesteder"}[r]||"steder")})}function E(){const n=document.querySelectorAll(".chapter-map");0!==n.length?placyMapConfig&&placyMapConfig.mapboxToken?(!function(){if(placyMapConfig&&placyMapConfig.startLocation)return void(a=placyMapConfig.startLocation);const e=document.querySelector(".tema-story-container");if(e){const t=e.getAttribute("data-start-lat"),o=e.getAttribute("data-start-lng");t&&o&&(a=[parseFloat(o),parseFloat(t)])}}(),mapboxgl.accessToken=placyMapConfig.mapboxToken,n.forEach(function(n){const r=n.getAttribute("data-chapter-id");if(!r)return void console.warn("Multi Map: Map missing data-chapter-id");const s=new mapboxgl.Map({container:n.id,style:"mapbox://styles/mapbox/light-v11",center:e.DEFAULT_CENTER,zoom:e.DEFAULT_ZOOM,minZoom:11,maxZoom:16});var l;s.addControl(new mapboxgl.NavigationControl,"top-right"),n._mapboxInstance=s,(l=s)&&(l.on("zoom",function(){p(l.getZoom())}),l.on("load",function(){p(l.getZoom())})),s.on("load",function(){s.getStyle().layers.forEach(function(e){(e.id.includes("poi")||e.id.includes("label"))&&s.setLayoutProperty(e.id,"visibility","none")}),a&&function(e){if(!a)return;const t=placyMapConfig.propertyLogo,n=placyMapConfig.propertyBackground,r=placyMapConfig.propertyLabel||"Eiendommen",s=document.createElement("div");s.className="tema-story-marker-wrapper",s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.gap="8px",s.style.cursor="pointer",s.style.zIndex="1000",s.setAttribute("data-marker-type","property");const i=d(e.getZoom()),l=document.createElement("div");l.className="marker-circle-container",l.style.width=i+"px",l.style.height=i+"px",l.style.borderRadius="50%",l.style.border="3px solid white",l.style.overflow="hidden",l.style.boxShadow="0 2px 8px rgba(0,0,0,0.2)",l.style.transition="transform 0.3s ease, box-shadow 0.3s ease, width 0.3s ease, height 0.3s ease",l.style.transformOrigin="center center",n?(l.style.backgroundImage=`url(${n})`,l.style.backgroundSize="cover",l.style.backgroundPosition="center"):t?(l.style.backgroundColor="white",l.style.backgroundImage=`url(${t})`,l.style.backgroundSize="60%",l.style.backgroundPosition="center",l.style.backgroundRepeat="no-repeat"):l.style.backgroundColor="#e74c3c";const c=document.createElement("div");c.className="marker-label-container marker-label-property",c.style.display="flex",c.style.flexDirection="column",c.style.alignItems="center",c.style.gap="2px",c.style.maxWidth="120px",c.style.textAlign="center",c.style.opacity="1",c.style.visibility="visible",c.style.pointerEvents="auto";const p=document.createElement("div");p.className="marker-name-label",p.textContent=r,p.style.fontSize="12px",p.style.fontWeight="600",p.style.color="#1a202c",p.style.lineHeight="1.2",p.style.textShadow="0 1px 2px rgba(255,255,255,0.8)",p.style.whiteSpace="nowrap",p.style.overflow="hidden",p.style.textOverflow="ellipsis",p.style.width="100%",c.appendChild(p);const u=document.createElement("div");u.textContent="Punkt A",u.style.fontSize="10px",u.style.fontWeight="500",u.style.color="#6B7280",u.style.textShadow="0 1px 2px rgba(255,255,255,0.8)",c.appendChild(u),s.appendChild(l),s.appendChild(c),s.addEventListener("mouseenter",function(){l.style.transform="scale(1.15)",l.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)"}),s.addEventListener("mouseleave",function(){l.style.transform="scale(1)",l.style.boxShadow="0 2px 8px rgba(0,0,0,0.2)"});const y=new mapboxgl.Marker({element:s,anchor:"center",offset:[0,-10]}).setLngLat(a).addTo(e);o.push(y)}(s),async function(e,t){const o=document.querySelector(`.chapter[data-chapter-id="${t}"]`);if(!o)return void console.warn(`Multi Map: Chapter ${t} not found in DOM`);const n=o.querySelectorAll(".poi-list-item[data-poi-coords], .poi-list-card[data-poi-coords]"),r=[];let s=0;for(const o of n){const n=o.closest(".poi-list-dynamic-results");if(n&&"none"===n.style.display)continue;const l=o.getAttribute("data-poi-coords"),c=o.getAttribute("data-poi-id"),d=o.getAttribute("data-poi-title");let p=o.getAttribute("data-poi-image");if(o.getAttribute("data-google-place-id")&&!p){const e=o.getAttribute("data-google-photo-reference");e&&(p=i(e,200))}if(l)try{const n=JSON.parse(l);if(Array.isArray(n)&&2===n.length){const i=[parseFloat(n[1]),parseFloat(n[0])];let l=null;if(a&&(l=await m(i),l)){const e=o.querySelector(".poi-walking-time");e&&(e.textContent=g(l.duration)+" gange")}const y=o.querySelector(".poi-rating-value"),f=o.querySelector(".poi-rating-count");let h=null;if(y){const e=y.textContent.replace(/\s+/g," ").trim().match(/(\d+\.?\d*)/);e&&(h={value:parseFloat(e[1]),count:f?f.textContent.trim():null})}const b={id:c,title:d||"POI",coords:i,image:p,element:o,index:s,walking:l,rating:h};r.push(b),u(e,b,t),s++}}catch(e){console.warn("Multi Map: Error parsing POI coords:",e)}}r.length>0&&_(e,r)}(s,r),document.querySelectorAll(".poi-list-dynamic-block").forEach(function(e){if("false"===e.getAttribute("data-places-enabled"))return;const t=e.closest("[data-chapter-id]");if(!t)return void console.warn("Dynamic POI block found outside chapter:",e);const o=t.getAttribute("data-chapter-id"),n=e.getAttribute("data-places-category")||"restaurant";e.getAttribute("data-places-keyword"),function(e,t,o){const n=e.querySelector(".poi-list-dynamic-placeholder");if(!n)return;if(n.querySelector(".places-api-show-all-button"))return;const r=document.createElement("div");r.className="places-api-button-container",r.style.marginTop="24px",r.style.textAlign="center";const s=document.createElement("button");s.className="places-api-show-all-button",s.textContent="Se flere "+o+" i omr√•det",s.setAttribute("data-category-norwegian",o),s.style.padding="12px 24px",s.style.backgroundColor="#EF4444",s.style.color="white",s.style.border="none",s.style.borderRadius="8px",s.style.fontSize="14px",s.style.fontWeight="600",s.style.cursor="pointer",s.style.transition="background-color 0.2s",s.addEventListener("mouseenter",function(){s.style.backgroundColor="#DC2626"}),s.addEventListener("mouseleave",function(){s.style.backgroundColor="#EF4444"}),s.addEventListener("click",function(){!async function(e,t,o){const n=o.hasAttribute("data-results-shown");if(n)return;const r=o.getAttribute("data-category-norwegian")||"steder",s=document.createElement("span");if(s.style.display="inline-block",s.style.width="14px",s.style.height="14px",s.style.border="2px solid rgba(255, 255, 255, 0.3)",s.style.borderTopColor="#fff",s.style.borderRadius="50%",s.style.marginRight="8px",s.style.animation="spin 0.8s linear infinite",!document.getElementById("spinner-keyframes")){const e=document.createElement("style");e.id="spinner-keyframes",e.textContent="\n                @keyframes spin {\n                    to { transform: rotate(360deg); }\n                }\n            ",document.head.appendChild(e)}o.innerHTML="",o.appendChild(s),o.appendChild(document.createTextNode("Henter lignende "+r+" fra Google...")),o.disabled=!0,o.style.opacity="0.9";const i=await async function(e,t){const o=document.querySelector('[data-chapter-id="'+t+'"]');if(!o)return null;const n=document.querySelector('.chapter-map[data-chapter-id="'+t+'"]');if(!n)return null;const r=n._mapboxInstance;if(!r)return null;let s,i;if(a)i=a[0],s=a[1];else{const e=r.getCenter();s=e.lat,i=e.lng}const l=e.getAttribute("data-places-category")||"restaurant",c=parseInt(e.getAttribute("data-places-radius"))||1500,d=parseFloat(e.getAttribute("data-places-min-rating"))||4.3,p=parseInt(e.getAttribute("data-places-min-reviews"))||50,u=e.getAttribute("data-places-keyword")||"";let y=["lodging"];const m=e.getAttribute("data-places-exclude-types");if(m)try{y=JSON.parse(m)}catch(e){console.warn("Failed to parse exclude types:",e)}const g=[],f=o.closest(".wp-block-placy-chapter-wrapper");f&&(f.querySelectorAll("[data-google-place-id]").forEach(function(e){const t=e.getAttribute("data-google-place-id");t&&t.trim()&&g.push(t.trim())}),console.log("[fetchDynamicBlockData] Excluding "+g.length+" manually curated POIs from API search"));const h=t+"-"+l+"-"+u;console.log("[fetchDynamicBlockData] Fetching places:",{blockId:h,lat:s,lng:i,category:l,radius:c,minRating:d,minReviews:p,keyword:u});const x=await b(h,s,i,l,c,d,p,u,y,g);return console.log("[fetchDynamicBlockData] API Response:",{success:x.success,count:x.places?.length||0}),x.success&&0!==x.places.length?x:(console.warn("[fetchDynamicBlockData] No places found for dynamic block"),null)}(e,t);await new Promise(e=>setTimeout(e,2e3)),i&&i.success&&i.places.length>0?(console.log("[Google Places] Successfully fetched "+i.places.length+" places"),function(e,t,o){console.log("[displayDynamicBlockResults] Starting display with "+o.places.length+" places");const a=document.querySelector('.chapter-map[data-chapter-id="'+t+'"]');if(!a)return void console.error("[displayDynamicBlockResults] No map container found for chapter:",t);const n=a._mapboxInstance;if(!n)return;const r=e.getAttribute("data-places-category")||"restaurant",s=e.getAttribute("data-places-keyword")||"",i={restaurant:"restauranter",cafe:"kafeer",bar:"barer",bakery:"bakerier",meal_takeaway:"takeaway-steder",food:"spisesteder",pharmacy:"apotek",dentist:"tannleger",doctor:"leger",hospital:"sykehus",physiotherapist:"fysioterapeuter",store:"butikker",supermarket:"supermarkeder",gym:"treningssentre",spa:"spa-steder",beauty_salon:"skj√∏nnhetssalonger",hair_care:"fris√∏rer",museum:"museer",art_gallery:"kunstgallerier",performing_arts_theater:"teatre",movie_theater:"kinoer",park:"parker",tourist_attraction:"turistattraksjoner"},l=i[r]||"steder",c=e.querySelector(".poi-list-dynamic-placeholder");if(!c)return;const d=document.createElement("div");d.className="places-api-results",d.style.marginTop="24px",d.style.paddingTop="0";const p=document.createElement("div");p.className="google-places-disclaimer",p.style.marginBottom="16px",p.style.padding="12px 16px",p.style.backgroundColor="#F3F4F6",p.style.borderLeft="4px solid #9CA3AF",p.style.borderRadius="4px";let u='<p style="margin: 0; font-size: 14px; color: #4B5563; line-height: 1.5;">';u+='<strong style="color: #1F2937;">Google-s√∏k:</strong> ',s&&s.trim()?u+="Viser lignende <strong>"+l+'</strong> tagget med <em>"'+s.trim()+'"</em>':u+="Viser lignende <strong>"+l+"</strong> i omr√•det",u+=' <span style="color: #6B7280;">‚Äî hentet fra Google Places</span>',u+="</p>",p.innerHTML=u,d.appendChild(p),o.places.forEach(function(e){const t=w(e);d.appendChild(t)}),c.appendChild(d),x(n,t,o.places),k(n,o.places)}(e,t,i),o.setAttribute("data-results-shown","true"),o.style.display="none"):(console.warn("[Google Places] No places found, resetting button"),o.innerHTML="",o.textContent="Se flere "+r+" i omr√•det",o.disabled=!1,o.style.opacity="1")}(e,t,s)}),r.appendChild(s),n.appendChild(r)}(e,o,{restaurant:"restauranter",cafe:"kafeer",bar:"barer",bakery:"bakerier",meal_takeaway:"takeaway-steder",food:"spisesteder",pharmacy:"apotek",dentist:"tannleger",doctor:"leger",hospital:"sykehus",physiotherapist:"fysioterapeuter",store:"butikker",supermarket:"supermarkeder",gym:"treningssentre",spa:"spa-steder",beauty_salon:"skj√∏nnhetssalonger",hair_care:"fris√∏rer",museum:"museer",art_gallery:"kunstgallerier",performing_arts_theater:"teatre",movie_theater:"kinoer",park:"parker",tourist_attraction:"turistattraksjoner"}[n]||"steder")})}),t=s}),setTimeout(function(){S()},1e3)):console.error("Multi Map: Mapbox token not found"):console.warn("Multi Map: No chapter maps found")}function S(){const e=document.querySelectorAll(".poi-list-item, .poi-list-card");0!==e.length&&e.forEach(function(e){e.addEventListener("mouseenter",function(){!function(e){const t=e.getAttribute("data-poi-id"),a=e.getAttribute("data-place-id");if(!t&&!a)return;I(),e.classList.add("poi-active-hover"),t?function(e){M(),o.forEach(function(t){const o=t.getElement();if(!o)return;if("property"===o.getAttribute("data-marker-type"))return;if(o.getAttribute("data-poi-id")===e){o.style.zIndex="50";const e=o.querySelector(".marker-circle-container");e&&(e.style.transform="scale(1.15)",e.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)");const t=o.querySelector(".marker-image-container");t&&(t.style.transform="scale(1.1)",o.style.filter="drop-shadow(0 4px 8px rgba(0,0,0,0.4))");const a=o.querySelector(".marker-label-poi");a&&(a.style.opacity="1",a.style.visibility="visible",a.style.pointerEvents="auto",a.setAttribute("data-force-visible","true"));const n=o.querySelector(".marker-info-card");n&&(n.style.opacity="1",n.style.visibility="visible",n.style.pointerEvents="auto",n.setAttribute("data-force-visible","true"))}})}(t):a&&function(e){M(),o.forEach(function(t){const o=t.getElement();if(!o)return;if("property"===o.getAttribute("data-marker-type"))return;if(o.getAttribute("data-place-id")===e){o.style.zIndex="50";const e=o.querySelector(".marker-circle-container");e&&(e.style.transform="scale(1.15)",e.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)");const t=o.querySelector(".marker-image-container");t&&(t.style.transform="scale(1.1)",o.style.filter="drop-shadow(0 4px 8px rgba(0,0,0,0.4))");const a=o.querySelector(".marker-label-container");a&&(a.style.opacity="1",a.style.visibility="visible",a.style.pointerEvents="auto",a.setAttribute("data-force-visible","true"));const n=o.querySelector(".marker-info-card");n&&(n.style.opacity="1",n.style.visibility="visible",n.style.pointerEvents="auto",n.setAttribute("data-force-visible","true"))}})}(a)}(this)}),e.addEventListener("mouseleave",function(){I()})})}function C(e){e||h(),document.querySelectorAll(".poi-list-item, .poi-list-card").forEach(function(e){e.classList.remove("poi-active-click");const t=e.querySelector(".poi-button-container"),o=e.querySelector('.poi-show-on-map, button[onclick*="showPOIOnMap"]');if(t){const e=t.querySelector(".poi-clear-button");e&&e.remove()}if(o){o.textContent="Se p√• kart";const e=o.classList.contains("poi-show-on-map"),t=o.closest(".poi-list-item, .poi-list-card"),a=t&&t.classList.contains("poi-gallery-item");o.className=o.className.replace(/bg-\S+/g,"").replace(/text-\S+/g,"").replace(/hover:bg-\S+/g,""),o.className=e?"poi-show-on-map px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium text-xs rounded transition-colors duration-200 whitespace-nowrap":a?"inline-flex items-center gap-2 px-4 py-2 text-sm bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors":"inline-flex items-center gap-2 px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors"}})}function L(e){return new Promise(function(t){C(!0);const a=document.querySelector(`.poi-list-item[data-poi-id="${e}"], .poi-list-card[data-poi-id="${e}"]`);if(a){a.classList.add("poi-active-click");const n=a.querySelector('.poi-show-on-map, button[onclick*="showPOIOnMap"]');if(n){const e=n.classList.contains("poi-show-on-map"),t=n.classList.contains("text-sm");n.textContent="‚úì Aktivt i kartet",n.className=n.className.replace(/bg-\S+/g,"").replace(/text-\S+/g,"").replace(/hover:bg-\S+/g,""),n.classList.add("bg-emerald-600","hover:bg-emerald-700","text-white"),e?n.classList.add("px-3","py-1.5","font-medium","text-xs","rounded","transition-colors","duration-200","whitespace-nowrap"):t?n.classList.add("inline-flex","items-center","gap-2","px-4","py-2","text-sm","rounded-lg","transition-colors"):n.classList.add("inline-flex","items-center","gap-2","px-6","py-2","rounded-lg","transition-colors");const o=a.querySelector(".poi-button-container");if(o&&!o.querySelector(".poi-clear-button")){const a=document.createElement("button");a.className=e?"poi-clear-button px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium text-xs rounded transition-colors duration-200 whitespace-nowrap":t?"poi-clear-button inline-flex items-center gap-2 px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors":"poi-clear-button inline-flex items-center gap-2 px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors font-medium",a.textContent="Fjern markering",a.onclick=function(e){e.stopPropagation(),C()},o.appendChild(a)}}a.scrollIntoView({behavior:"smooth",block:"center"}),o.forEach(function(t){const o=t.getElement();if(!o)return;if(o.getAttribute("data-poi-id")===e){o.style.zIndex="1000";const e=o.querySelector(".tema-story-marker-label");e&&(e.style.backgroundColor="#EFE9DE",e.style.border="1px solid #cbbda4",e.style.boxShadow="0 4px 16px rgba(203, 189, 164, 0.3)",e.style.fontWeight="700")}}),setTimeout(t,600)}else t()})}function I(){document.querySelectorAll(".poi-list-item, .poi-list-card").forEach(function(e){e.classList.remove("poi-active-hover")}),M()}function M(){o.forEach(function(e){const t=e.getElement();if(!t)return;if("property"===t.getAttribute("data-marker-type"))return;t.classList.remove("marker-active"),t.style.zIndex="10";const o=t.querySelector(".marker-circle-container");o&&(o.style.transform="scale(1)",o.style.boxShadow="0 2px 8px rgba(0,0,0,0.2)");const a=t.querySelector(".marker-image-container");a&&(a.style.transform="scale(1)",t.style.filter="drop-shadow(0 2px 4px rgba(0,0,0,0.3))");const n=t.querySelector(".marker-label-poi, .marker-label-container");if(n){n.removeAttribute("data-force-visible");const e=t.closest(".chapter-map");if(e&&e._mapboxInstance){e._mapboxInstance.getZoom()<15&&(n.style.opacity="0",n.style.visibility="hidden",n.style.pointerEvents="none")}}const r=t.querySelector(".marker-info-card");if(r){r.removeAttribute("data-force-visible");const e=t.closest(".chapter-map");if(e&&e._mapboxInstance){e._mapboxInstance.getZoom()<15&&(r.style.opacity="0",r.style.visibility="hidden",r.style.pointerEvents="none")}}})}function _(t,o){if(o&&0!==o.length)if(1===o.length)t.flyTo({center:o[0].coords,zoom:e.DEFAULT_ZOOM,duration:1e3});else{const n=new mapboxgl.LngLatBounds;o.forEach(function(e){n.extend(e.coords)}),a&&n.extend(a),t.fitBounds(n,{padding:e.FIT_BOUNDS_PADDING,duration:1e3})}}function T(){document.querySelectorAll(".poi-list-dynamic-block .places-api-show-all-button").forEach(function(e){const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("mouseenter",function(){t.disabled||(t.style.backgroundColor="#DC2626")}),t.addEventListener("mouseleave",function(){t.disabled||(t.style.backgroundColor="#EF4444")}),t.addEventListener("click",function(){!async function(e){const t=e.closest(".poi-list-dynamic-block");if(!t)return;const o=t.querySelector(".poi-list-dynamic-results");if(!o)return;const n=e.getAttribute("data-category-norwegian")||"steder",r=document.createElement("span");if(r.style.display="inline-block",r.style.width="14px",r.style.height="14px",r.style.border="2px solid rgba(255, 255, 255, 0.3)",r.style.borderTopColor="#fff",r.style.borderRadius="50%",r.style.marginRight="8px",r.style.animation="spin 0.8s linear infinite",!document.getElementById("spinner-keyframes")){const e=document.createElement("style");e.id="spinner-keyframes",e.textContent="\n                @keyframes spin {\n                    to { transform: rotate(360deg); }\n                }\n            ",document.head.appendChild(e)}e.innerHTML="",e.appendChild(r),e.appendChild(document.createTextNode("Henter lignende "+n+" fra Google...")),e.disabled=!0,e.style.opacity="0.9",await new Promise(e=>setTimeout(e,2e3)),o.style.display="flex";const s=t.closest(".chapter"),l=s?s.getAttribute("data-chapter-id"):null;if(l){const e=document.querySelector(`.chapter-map[data-chapter-id="${l}"]`),t=e?e._mapboxInstance:null;if(t){const e=o.querySelectorAll(".poi-list-card[data-poi-coords]"),n=new Set;t._poiMarkers&&t._poiMarkers.forEach(e=>{const t=e.getElement();if(t){const e=t.getAttribute("data-poi-id");e&&n.add(e)}});for(const o of e){const e=o.getAttribute("data-poi-coords"),r=o.getAttribute("data-poi-id"),s=o.getAttribute("data-poi-title");if(n.has(r))continue;let c=o.getAttribute("data-poi-image");if(o.getAttribute("data-google-place-id")&&!c){const e=o.getAttribute("data-google-photo-reference");e&&(c=i(e,200))}if(e)try{const n=JSON.parse(e);if(Array.isArray(n)&&2===n.length){const e=[parseFloat(n[1]),parseFloat(n[0])];let i=null;if(a&&(i=await m(e),i)){const e=o.querySelector(".poi-walking-time");e&&(e.textContent=g(i.duration)+" gange")}const d=o.querySelector(".poi-rating-value"),p=o.querySelector(".poi-rating-count");let y=null;if(d){const e=d.textContent.replace(/\s+/g," ").trim().match(/(\d+\.?\d*)/);e&&(y={value:parseFloat(e[1]),count:p?p.textContent.trim():null})}u(t,{id:r,title:s||"POI",coords:e,image:c,element:o,walking:i,rating:y},l)}}catch(e){console.warn("Error parsing revealed POI coords:",e)}}}}const c=e.closest(".places-api-button-container");c&&(c.style.display="none"),S()}(t)})})}window.showPOIOnMap=function(e){const t=e.closest(".poi-list-item, .poi-list-card");if(!t)return;const o=t.getAttribute("data-poi-coords");if(!o)return;const n=e.closest(".chapter");if(!n)return void console.warn("Could not find parent .chapter element for POI");const r=n.getAttribute("data-chapter-id");if(!r)return void console.warn("Chapter element missing data-chapter-id attribute");const s=document.querySelector('.chapter-map[data-chapter-id="'+r+'"]');if(!s)return void console.warn("Could not find map container for chapter:",r);const i=s._mapboxInstance;if(i)try{const e=JSON.parse(o);if(Array.isArray(e)&&2===e.length){const o=[parseFloat(e[1]),parseFloat(e[0])],n=t.getAttribute("data-poi-id");if(a){const e=new mapboxgl.LngLatBounds;e.extend(a),e.extend(o),i.fitBounds(e,{padding:120,duration:1200,maxZoom:16})}else i.flyTo({center:o,zoom:16,duration:1200,essential:!0});const r=s.closest(".chapter-map-column");r&&window.innerWidth<1024&&r.scrollIntoView({behavior:"smooth",block:"nearest"}),a&&m(o).then(function(e){e&&e.geometry&&setTimeout(function(){y(i,e.geometry,e.duration)},400)}),n&&setTimeout(function(){L(n)},800)}}catch(e){console.warn("Error showing POI on map:",e)}else console.warn("Map not initialized for chapter:",r)},window.showPlaceOnMap=function(e){const t=e.closest(".poi-list-card");if(!t)return;const o=e.getAttribute("data-place-coords");if(!o)return;const n=e.closest(".chapter");if(!n)return void console.warn("Could not find parent .chapter element for Place");const r=n.getAttribute("data-chapter-id");if(!r)return void console.warn("Chapter element missing data-chapter-id attribute");const s=document.querySelector('.chapter-map[data-chapter-id="'+r+'"]');if(!s)return void console.warn("Could not find map container for chapter:",r);const i=s._mapboxInstance;if(i)try{const e=JSON.parse(o);if(Array.isArray(e)&&2===e.length){const o=[parseFloat(e[0]),parseFloat(e[1])],n=t.getAttribute("data-place-id");if(a){const e=new mapboxgl.LngLatBounds;e.extend(a),e.extend(o),i.fitBounds(e,{padding:120,duration:1200,maxZoom:16})}else i.flyTo({center:o,zoom:16,duration:1200,essential:!0});a&&m(o).then(function(e){e&&e.geometry&&setTimeout(function(){y(i,e.geometry,e.duration)},400)}),n&&setTimeout(function(){const e=s.querySelector('.marker-wrapper-places[data-place-id="'+n+'"]');e&&(e.style.animation="marker-pulse 1s ease-in-out 3",setTimeout(function(){e.style.animation=""},3e3))},1200)}}catch(e){console.warn("Error showing Place on map:",e)}else console.warn("Map not initialized for chapter:",r)},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){E(),T(),setTimeout(function(){A()},2e3)}):(E(),T(),setTimeout(function(){A()},2e3))}();